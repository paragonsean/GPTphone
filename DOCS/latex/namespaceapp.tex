\doxysection{app Namespace Reference}
\hypertarget{namespaceapp}{}\label{namespaceapp}\index{app@{app}}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
HTMLResponse \mbox{\hyperlink{namespaceapp_a27a6b82e611a9842f390d7edd6963fce}{incoming\+\_\+call}} ()
\item 
\mbox{\hyperlink{namespaceapp_a183b3a5f9f470b5c2c082ee47d7cf9b5}{get\+\_\+call\+\_\+recording}} (str call\+\_\+sid)
\item 
\mbox{\hyperlink{namespaceapp_ad2f80d8ec2d5b42d67d7f5e5945d15c5}{websocket\+\_\+endpoint}} (Web\+Socket websocket)
\item 
\mbox{\hyperlink{namespaceapp_ad2f5126055cf6800953daf1ab8298f01}{get\+\_\+twilio\+\_\+client}} ()
\item 
\mbox{\hyperlink{namespaceapp_ad13a0e6462b6ae78699c168a29b7e40d}{start\+\_\+call}} (Dict\mbox{[}str, str\mbox{]} request)
\item 
\mbox{\hyperlink{namespaceapp_a09bf5cdac5d1f13fdb976420f4b55ee1}{get\+\_\+call\+\_\+status}} (str call\+\_\+sid)
\item 
\mbox{\hyperlink{namespaceapp_a1ba1dcf83aa35b0d6027c93f14f72fff}{end\+\_\+call}} (Dict\mbox{[}str, str\mbox{]} request)
\item 
\mbox{\hyperlink{namespaceapp_a160f5539bbbb445a20caaa834f47ddda}{get\+\_\+transcript}} (str call\+\_\+sid)
\item 
\mbox{\hyperlink{namespaceapp_a2d1bcb37ee8fa845cbd94b2e0acb1258}{get\+\_\+all\+\_\+transcripts}} ()
\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{namespaceapp_afe63fea7be31b0200b496d08bc6b517d}{app}} = Fast\+API()
\item 
\mbox{\hyperlink{namespaceapp_a0b14e488ae28d98d262453f3e9cd6e4d}{logger}} = get\+\_\+logger("{}App"{})
\item 
dict \mbox{\hyperlink{namespaceapp_aef7f4ba3e723d6fd588089b84d83b37c}{call\+\_\+contexts}} = \{\}
\item 
\mbox{\hyperlink{namespaceapp_af8fb0f45ee0195c7422a49e6a8d72369}{port}} = int(os.\+getenv("{}PORT"{}, 3000))
\item 
\mbox{\hyperlink{namespaceapp_a832ddc04754e8a43d4f3c6165b1294a7}{host}}
\end{DoxyCompactItemize}


\doxysubsection{Function Documentation}
\Hypertarget{namespaceapp_a1ba1dcf83aa35b0d6027c93f14f72fff}\index{app@{app}!end\_call@{end\_call}}
\index{end\_call@{end\_call}!app@{app}}
\doxysubsubsection{\texorpdfstring{end\_call()}{end\_call()}}
{\footnotesize\ttfamily \label{namespaceapp_a1ba1dcf83aa35b0d6027c93f14f72fff} 
end\+\_\+call (\begin{DoxyParamCaption}\item[{Dict\mbox{[}str, str\mbox{]}}]{request}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Get the status of a call.\end{DoxyVerb}
 
\begin{DoxyCode}{0}
\DoxyCodeLine{00253\ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{namespaceend__call}{end\_call}}(request:\ Dict[str,\ str]):}
\DoxyCodeLine{00254\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Get\ the\ status\ of\ a\ call."{}"{}"{}}}
\DoxyCodeLine{00255\ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \ \ call\_sid\ =\ request.get(\textcolor{stringliteral}{"{}call\_sid"{}})}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \ \ client\ =\ get\_twilio\_client()}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ client.calls(call\_sid).update(status=\textcolor{stringliteral}{'completed'})}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}status"{}}:\ \textcolor{stringliteral}{"{}success"{}}\}}
\DoxyCodeLine{00260\ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{00261\ \ \ \ \ \ \ \ \ logger.error(f\textcolor{stringliteral}{"{}Error\ ending\ call\ \{str(e)\}"{}})}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}error"{}}:\ f\textcolor{stringliteral}{"{}Failed\ to\ end\ requested\ call:\ \{str(e)\}"{}}\}}
\DoxyCodeLine{00263\ }
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00265\ \textcolor{comment}{\#\ API\ call\ to\ get\ the\ transcript\ for\ a\ specific\ call}}
\DoxyCodeLine{00266\ \textcolor{preprocessor}{@app.get("{}/transcript/\{call\_sid\}"{})}}

\end{DoxyCode}


References \mbox{\hyperlink{l00191}{get\+\_\+twilio\+\_\+client()}}.

Here is the call graph for this function\+:
% FIG 0
\Hypertarget{namespaceapp_a2d1bcb37ee8fa845cbd94b2e0acb1258}\index{app@{app}!get\_all\_transcripts@{get\_all\_transcripts}}
\index{get\_all\_transcripts@{get\_all\_transcripts}!app@{app}}
\doxysubsubsection{\texorpdfstring{get\_all\_transcripts()}{get\_all\_transcripts()}}
{\footnotesize\ttfamily \label{namespaceapp_a2d1bcb37ee8fa845cbd94b2e0acb1258} 
get\+\_\+all\+\_\+transcripts (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Get a list of all current call transcripts.\end{DoxyVerb}
 
\begin{DoxyCode}{0}
\DoxyCodeLine{00280\ \textcolor{keyword}{async\ def\ }get\_all\_transcripts():}
\DoxyCodeLine{00281\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Get\ a\ list\ of\ all\ current\ call\ transcripts."{}"{}"{}}}
\DoxyCodeLine{00282\ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ transcript\_list\ =\ []}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ call\_sid,\ context\ \textcolor{keywordflow}{in}\ call\_contexts.items():}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ \ \ transcript\_list.append(\{}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}call\_sid"{}}:\ call\_sid,}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}transcript"{}}:\ context.user\_context,}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \ \ \ \ \})}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}transcripts"{}}:\ transcript\_list\}}
\DoxyCodeLine{00290\ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ logger.error(f\textcolor{stringliteral}{"{}Error\ fetching\ all\ transcripts:\ \{str(e)\}"{}})}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}error"{}}:\ f\textcolor{stringliteral}{"{}Failed\ to\ fetch\ all\ transcripts:\ \{str(e)\}"{}}\}}
\DoxyCodeLine{00293\ }
\DoxyCodeLine{00294\ }

\end{DoxyCode}
\Hypertarget{namespaceapp_a183b3a5f9f470b5c2c082ee47d7cf9b5}\index{app@{app}!get\_call\_recording@{get\_call\_recording}}
\index{get\_call\_recording@{get\_call\_recording}!app@{app}}
\doxysubsubsection{\texorpdfstring{get\_call\_recording()}{get\_call\_recording()}}
{\footnotesize\ttfamily \label{namespaceapp_a183b3a5f9f470b5c2c082ee47d7cf9b5} 
get\+\_\+call\+\_\+recording (\begin{DoxyParamCaption}\item[{str}]{call\+\_\+sid}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Get the recording URL for a specific call.\end{DoxyVerb}
 
\begin{DoxyCode}{0}
\DoxyCodeLine{00049\ \textcolor{keyword}{async\ def\ }get\_call\_recording(call\_sid:\ str):}
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Get\ the\ recording\ URL\ for\ a\ specific\ call."{}"{}"{}}}
\DoxyCodeLine{00051\ \ \ \ \ recording\ =\ get\_twilio\_client().calls(call\_sid).recordings.list()}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keywordflow}{if}\ recording:}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ print(\{\textcolor{stringliteral}{"{}recording\_url"{}}:\ f\textcolor{stringliteral}{"{}https://api.twilio.com/\{recording[0].uri\}"{}}\})}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}recording\_url"{}}:\ f\textcolor{stringliteral}{"{}https://api.twilio.com/\{recording[0].uri\}"{}}\}}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ recording:}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}error"{}}:\ \textcolor{stringliteral}{"{}Recording\ not\ found"{}}\}}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \textcolor{comment}{\#\ Websocket\ route\ for\ Twilio\ to\ get\ media\ stream}}
\DoxyCodeLine{00060\ \textcolor{preprocessor}{@app.websocket("{}/connection"{})}}

\end{DoxyCode}


References \mbox{\hyperlink{l00191}{get\+\_\+twilio\+\_\+client()}}.

Here is the call graph for this function\+:
% FIG 1
\Hypertarget{namespaceapp_a09bf5cdac5d1f13fdb976420f4b55ee1}\index{app@{app}!get\_call\_status@{get\_call\_status}}
\index{get\_call\_status@{get\_call\_status}!app@{app}}
\doxysubsubsection{\texorpdfstring{get\_call\_status()}{get\_call\_status()}}
{\footnotesize\ttfamily \label{namespaceapp_a09bf5cdac5d1f13fdb976420f4b55ee1} 
get\+\_\+call\+\_\+status (\begin{DoxyParamCaption}\item[{str}]{call\+\_\+sid}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Get the status of a call.\end{DoxyVerb}
 
\begin{DoxyCode}{0}
\DoxyCodeLine{00240\ \textcolor{keyword}{async\ def\ }get\_call\_status(call\_sid:\ str):}
\DoxyCodeLine{00241\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Get\ the\ status\ of\ a\ call."{}"{}"{}}}
\DoxyCodeLine{00242\ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ client\ =\ get\_twilio\_client()}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ call\ =\ client.calls(call\_sid).fetch()}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}status"{}}:\ call.status\}}
\DoxyCodeLine{00246\ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ logger.error(f\textcolor{stringliteral}{"{}Error\ fetching\ call\ status:\ \{str(e)\}"{}})}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}error"{}}:\ f\textcolor{stringliteral}{"{}Failed\ to\ fetch\ call\ status:\ \{str(e)\}"{}}\}}
\DoxyCodeLine{00249\ }
\DoxyCodeLine{00250\ }
\DoxyCodeLine{00251\ \textcolor{comment}{\#\ API\ route\ to\ end\ a\ call}}
\DoxyCodeLine{00252\ \textcolor{preprocessor}{@app.post("{}/end\_call"{})}}

\end{DoxyCode}


References \mbox{\hyperlink{l00191}{get\+\_\+twilio\+\_\+client()}}.

Here is the call graph for this function\+:
% FIG 2
\Hypertarget{namespaceapp_a160f5539bbbb445a20caaa834f47ddda}\index{app@{app}!get\_transcript@{get\_transcript}}
\index{get\_transcript@{get\_transcript}!app@{app}}
\doxysubsubsection{\texorpdfstring{get\_transcript()}{get\_transcript()}}
{\footnotesize\ttfamily \label{namespaceapp_a160f5539bbbb445a20caaa834f47ddda} 
get\+\_\+transcript (\begin{DoxyParamCaption}\item[{str}]{call\+\_\+sid}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Get the entire transcript for a specific call.\end{DoxyVerb}
 
\begin{DoxyCode}{0}
\DoxyCodeLine{00267\ \textcolor{keyword}{async\ def\ }get\_transcript(call\_sid:\ str):}
\DoxyCodeLine{00268\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Get\ the\ entire\ transcript\ for\ a\ specific\ call."{}"{}"{}}}
\DoxyCodeLine{00269\ \ \ \ \ call\_context\ =\ call\_contexts.get(call\_sid)}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00271\ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ call\_context:}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}[GET]\ Call\ not\ found\ for\ call\ SID:\ \{call\_sid\}"{}})}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}error"{}}:\ \textcolor{stringliteral}{"{}Call\ not\ found"{}}\}}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00275\ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}transcript"{}}:\ call\_context.user\_context\}}
\DoxyCodeLine{00276\ }
\DoxyCodeLine{00277\ }
\DoxyCodeLine{00278\ \textcolor{comment}{\#\ API\ route\ to\ get\ all\ call\ transcripts}}
\DoxyCodeLine{00279\ \textcolor{preprocessor}{@app.get("{}/all\_transcripts"{})}}

\end{DoxyCode}
\Hypertarget{namespaceapp_ad2f5126055cf6800953daf1ab8298f01}\index{app@{app}!get\_twilio\_client@{get\_twilio\_client}}
\index{get\_twilio\_client@{get\_twilio\_client}!app@{app}}
\doxysubsubsection{\texorpdfstring{get\_twilio\_client()}{get\_twilio\_client()}}
{\footnotesize\ttfamily \label{namespaceapp_ad2f5126055cf6800953daf1ab8298f01} 
get\+\_\+twilio\+\_\+client (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00191\ \textcolor{keyword}{def\ }get\_twilio\_client():}
\DoxyCodeLine{00192\ \ \ \ \ \textcolor{keywordflow}{return}\ Client(os.getenv(\textcolor{stringliteral}{"{}TWILIO\_ACCOUNT\_SID"{}}),\ os.getenv(\textcolor{stringliteral}{"{}TWILIO\_AUTH\_TOKEN"{}}))}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ \textcolor{comment}{\#\ API\ route\ to\ initiate\ a\ call\ via\ UI}}
\DoxyCodeLine{00196\ \textcolor{preprocessor}{@app.post("{}/start\_call"{})}}

\end{DoxyCode}


Referenced by \mbox{\hyperlink{l00253}{end\+\_\+call()}}, \mbox{\hyperlink{l00049}{get\+\_\+call\+\_\+recording()}}, \mbox{\hyperlink{l00240}{get\+\_\+call\+\_\+status()}}, \mbox{\hyperlink{l00197}{start\+\_\+call()}}, and \mbox{\hyperlink{l00061}{websocket\+\_\+endpoint()}}.

Here is the caller graph for this function\+:
% FIG 3
\Hypertarget{namespaceapp_a27a6b82e611a9842f390d7edd6963fce}\index{app@{app}!incoming\_call@{incoming\_call}}
\index{incoming\_call@{incoming\_call}!app@{app}}
\doxysubsubsection{\texorpdfstring{incoming\_call()}{incoming\_call()}}
{\footnotesize\ttfamily \label{namespaceapp_a27a6b82e611a9842f390d7edd6963fce} 
 HTMLResponse incoming\+\_\+call (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00039\ \textcolor{keyword}{async\ def\ }incoming\_call()\ -\/>\ HTMLResponse:}
\DoxyCodeLine{00040\ \ \ \ \ server\ =\ os.environ.get(\textcolor{stringliteral}{"{}SERVER"{}})}
\DoxyCodeLine{00041\ \ \ \ \ response\ =\ VoiceResponse()}
\DoxyCodeLine{00042\ \ \ \ \ connect\ =\ Connect()}
\DoxyCodeLine{00043\ \ \ \ \ connect.stream(url=f\textcolor{stringliteral}{"{}wss://\{server\}/connection"{}})}
\DoxyCodeLine{00044\ \ \ \ \ response.append(connect)}
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{keywordflow}{return}\ HTMLResponse(content=str(response),\ status\_code=200)}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \textcolor{preprocessor}{@app.get("{}/call\_recording/\{call\_sid\}"{})}}

\end{DoxyCode}
\Hypertarget{namespaceapp_ad13a0e6462b6ae78699c168a29b7e40d}\index{app@{app}!start\_call@{start\_call}}
\index{start\_call@{start\_call}!app@{app}}
\doxysubsubsection{\texorpdfstring{start\_call()}{start\_call()}}
{\footnotesize\ttfamily \label{namespaceapp_ad13a0e6462b6ae78699c168a29b7e40d} 
start\+\_\+call (\begin{DoxyParamCaption}\item[{Dict\mbox{[}str, str\mbox{]}}]{request}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Initiate a call using Twilio with optional system and initial messages.\end{DoxyVerb}
 
\begin{DoxyCode}{0}
\DoxyCodeLine{00197\ \textcolor{keyword}{async\ def\ }start\_call(request:\ Dict[str,\ str]):}
\DoxyCodeLine{00198\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Initiate\ a\ call\ using\ Twilio\ with\ optional\ system\ and\ initial\ messages."{}"{}"{}}}
\DoxyCodeLine{00199\ \ \ \ \ to\_number\ =\ request.get(\textcolor{stringliteral}{"{}to\_number"{}})}
\DoxyCodeLine{00200\ \ \ \ \ system\_message\ =\ request.get(\textcolor{stringliteral}{"{}system\_message"{}})}
\DoxyCodeLine{00201\ \ \ \ \ initial\_message\ =\ request.get(\textcolor{stringliteral}{"{}initial\_message"{}})}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ to\_number:}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ logger.error(\textcolor{stringliteral}{"{}Missing\ 'to\_number'\ in\ request"{}})}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ HTTPException(status\_code=400,\ detail=\textcolor{stringliteral}{"{}Missing\ 'to\_number'\ in\ request"{}})}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ \ \ service\_url\ =\ f\textcolor{stringliteral}{"{}https://\{os.getenv('SERVER')\}/incoming"{}}}
\DoxyCodeLine{00208\ }
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ client\ =\ get\_twilio\_client()}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Initiating\ call\ to\ \{to\_number\}\ via\ \{service\_url\}"{}})}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ call\ =\ client.calls.create(}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \ \ \ \ to=to\_number,}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \ \ from\_=os.getenv(\textcolor{stringliteral}{"{}APP\_NUMBER"{}}),}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \ \ \ \ url=service\_url}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ call\_sid\ =\ call.sid}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Create\ CallContext\ instance}}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ call\_context\ =\ CallContext(}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ \ \ call\_sid=call\_sid,}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ system\_message=system\_message\ \textcolor{keywordflow}{or}\ os.getenv(\textcolor{stringliteral}{"{}SYSTEM\_MESSAGE"{}}),}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ initial\_message=initial\_message\ \textcolor{keywordflow}{or}\ os.getenv(\textcolor{stringliteral}{"{}Config.INITIAL\_MESSAGE"{}}),}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \ \ \ \ to\_number=to\_number,}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \ \ \ \ from\_number=os.getenv(\textcolor{stringliteral}{"{}APP\_NUMBER"{}})}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{00227\ }
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Store\ call\ context\ in\ the\ database}}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ db\ =\ next(db\_manager.get\_db())}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ db\_manager.create\_call\_context(db,\ call\_context)}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00232\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}call\_sid"{}}:\ call\_sid\}}
\DoxyCodeLine{00233\ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ logger.error(f\textcolor{stringliteral}{"{}Error\ initiating\ call:\ \{str(e)\}"{}})}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ HTTPException(status\_code=500,\ detail=f\textcolor{stringliteral}{"{}Failed\ to\ initiate\ call:\ \{str(e)\}"{}})}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \textcolor{comment}{\#\ API\ route\ to\ get\ the\ status\ of\ a\ call}}
\DoxyCodeLine{00239\ \textcolor{preprocessor}{@app.get("{}/call\_status/\{call\_sid\}"{})}}

\end{DoxyCode}


References \mbox{\hyperlink{l00191}{get\+\_\+twilio\+\_\+client()}}.

Here is the call graph for this function\+:
% FIG 4
\Hypertarget{namespaceapp_ad2f80d8ec2d5b42d67d7f5e5945d15c5}\index{app@{app}!websocket\_endpoint@{websocket\_endpoint}}
\index{websocket\_endpoint@{websocket\_endpoint}!app@{app}}
\doxysubsubsection{\texorpdfstring{websocket\_endpoint()}{websocket\_endpoint()}}
{\footnotesize\ttfamily \label{namespaceapp_ad2f80d8ec2d5b42d67d7f5e5945d15c5} 
websocket\+\_\+endpoint (\begin{DoxyParamCaption}\item[{Web\+Socket}]{websocket}{}\end{DoxyParamCaption})}


\begin{DoxyCode}{0}
\DoxyCodeLine{00061\ \textcolor{keyword}{async\ def\ }websocket\_endpoint(websocket:\ WebSocket):}
\DoxyCodeLine{00062\ \ \ \ \ await\ websocket.accept()}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ \ \ llm\_service\_name\ =\ os.getenv(\textcolor{stringliteral}{"{}LLM\_SERVICE"{}},\ \textcolor{stringliteral}{"{}openai"{}})}
\DoxyCodeLine{00065\ \ \ \ \ tts\_service\_name\ =\ os.getenv(\textcolor{stringliteral}{"{}TTS\_SERVICE"{}},\ \textcolor{stringliteral}{"{}deepgram"{}})}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Using\ LLM\ service:\ \{llm\_service\_name\}"{}})}
\DoxyCodeLine{00068\ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Using\ TTS\ service:\ \{tts\_service\_name\}"{}})}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \ \ llm\_service\ =\ LLMFactory.get\_llm\_service(llm\_service\_name,\ CallContext())}
\DoxyCodeLine{00071\ \ \ \ \ stream\_service\ =\ StreamService(websocket)}
\DoxyCodeLine{00072\ \ \ \ \ transcription\_service\ =\ TranscriptionService()}
\DoxyCodeLine{00073\ \ \ \ \ tts\_service\ =\ TTSFactory.get\_tts\_service(tts\_service\_name)}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ marks\ =\ deque()}
\DoxyCodeLine{00076\ \ \ \ \ interaction\_count\ =\ 0}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \ \ await\ transcription\_service.connect()}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{keyword}{async\ def\ }process\_media(msg):}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ await\ transcription\_service.send(base64.b64decode(msg[\textcolor{stringliteral}{'media'}][\textcolor{stringliteral}{'payload'}]))}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keyword}{async\ def\ }handle\_transcription(text):}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ nonlocal\ interaction\_count}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ text:}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Interaction\ \{interaction\_count\}\ â€“\ STT\ -\/>\ LLM:\ \{text\}"{}})}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ await\ llm\_service.completion(text,\ interaction\_count)}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ interaction\_count\ +=\ 1}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{keyword}{async\ def\ }handle\_llm\_reply(llm\_reply,\ icount):}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Interaction\ \{icount\}:\ LLM\ -\/>\ TTS:\ \{llm\_reply['partialResponse']\}"{}})}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ await\ tts\_service.generate(llm\_reply,\ icount)}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{keyword}{async\ def\ }handle\_speech(response\_index,\ audio,\ label,\ icount):}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Interaction\ \{icount\}:\ TTS\ -\/>\ TWILIO:\ \{label\}"{}})}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ await\ stream\_service.buffer(response\_index,\ audio)}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{keyword}{async\ def\ }handle\_audio\_sent(mark\_label):}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ marks.append(mark\_label)}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \ \ \textcolor{keyword}{async\ def\ }handle\_utterance(text,\ stream\_sid):}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(marks)\ >\ 0\ \textcolor{keywordflow}{and}\ text.strip():}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(\textcolor{stringliteral}{"{}Intruption\ detected,\ clearing\ system."{}})}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ websocket.send\_json(\{}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}streamSid"{}}:\ stream\_sid,}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}event"{}}:\ \textcolor{stringliteral}{"{}clear"{}}}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \})}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ reset\ states}}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stream\_service.reset()}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ llm\_service.reset()}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ logger.error(f\textcolor{stringliteral}{"{}Error\ while\ handling\ utterance:\ \{e\}"{}})}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ e.print\_stack()}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \ \ \ \ transcription\_service.on(\textcolor{stringliteral}{'utterance'},\ handle\_utterance)}
\DoxyCodeLine{00120\ \ \ \ \ transcription\_service.on(\textcolor{stringliteral}{'transcription'},\ handle\_transcription)}
\DoxyCodeLine{00121\ \ \ \ \ llm\_service.on(\textcolor{stringliteral}{'llmreply'},\ handle\_llm\_reply)}
\DoxyCodeLine{00122\ \ \ \ \ tts\_service.on(\textcolor{stringliteral}{'speech'},\ handle\_speech)}
\DoxyCodeLine{00123\ \ \ \ \ stream\_service.on(\textcolor{stringliteral}{'audiosent'},\ handle\_audio\_sent)}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{comment}{\#\ Queue\ for\ incoming\ WebSocket\ messages}}
\DoxyCodeLine{00126\ \ \ \ \ message\_queue\ =\ asyncio.Queue()}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keyword}{async\ def\ }websocket\_listener():}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ \textcolor{keyword}{True}:}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ data\ =\ await\ websocket.receive\_text()}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ message\_queue.put(json.loads(data))}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ WebSocketDisconnect:}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(\textcolor{stringliteral}{"{}WebSocket\ disconnected"{}})}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{keyword}{async\ def\ }message\_processor():}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ \textcolor{keyword}{True}:}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ msg\ =\ await\ message\_queue.get()}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ msg[\textcolor{stringliteral}{'event'}]\ ==\ \textcolor{stringliteral}{'start'}:}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stream\_sid\ =\ msg[\textcolor{stringliteral}{'start'}][\textcolor{stringliteral}{'streamSid'}]}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ call\_sid\ =\ msg[\textcolor{stringliteral}{'start'}][\textcolor{stringliteral}{'callSid'}]}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ call\_context\ =\ CallContext()}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ os.getenv(\textcolor{stringliteral}{"{}RECORD\_CALLS"{}})\ ==\ \textcolor{stringliteral}{"{}true"{}}:}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ get\_twilio\_client().calls(call\_sid).recordings.create(\{\textcolor{stringliteral}{"{}recordingChannels"{}}:\ \textcolor{stringliteral}{"{}dual"{}}\})}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Decide\ if\ the\ call\ the\ call\ was\ initiated\ from\ the\ UI\ or\ is\ an\ inbound}}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ call\_sid\ \textcolor{keywordflow}{not}\ \textcolor{keywordflow}{in}\ call\_contexts:}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Inbound\ call}}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ call\_context.system\_message\ =\ os.environ.get(\textcolor{stringliteral}{"{}SYSTEM\_MESSAGE"{}})}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ call\_context.initial\_message\ =\ os.environ.get(\textcolor{stringliteral}{"{}INITIAL\_MESSAGE"{}})}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ call\_context.call\_sid\ =\ call\_sid}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ call\_contexts[call\_sid]\ =\ call\_context}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Call\ from\ UI,\ reuse\ the\ existing\ context}}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ call\_context\ =\ call\_contexts[call\_sid]}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ llm\_service.set\_call\_context(call\_context)}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stream\_service.set\_stream\_sid(stream\_sid)}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ transcription\_service.set\_stream\_sid(stream\_sid)}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Twilio\ -\/>\ Starting\ Media\ Stream\ for\ \{stream\_sid\}"{}})}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ tts\_service.generate(\{}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}partialResponseIndex"{}}:\ \textcolor{keywordtype}{None},}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}partialResponse"{}}:\ call\_context.initial\_message}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \},\ 1)}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ msg[\textcolor{stringliteral}{'event'}]\ ==\ \textcolor{stringliteral}{'media'}:}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ asyncio.create\_task(process\_media(msg))}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ msg[\textcolor{stringliteral}{'event'}]\ ==\ \textcolor{stringliteral}{'mark'}:}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ label\ =\ msg[\textcolor{stringliteral}{'mark'}][\textcolor{stringliteral}{'name'}]}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ label\ \textcolor{keywordflow}{in}\ marks:}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ marks.remove(label)}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ msg[\textcolor{stringliteral}{'event'}]\ ==\ \textcolor{stringliteral}{'stop'}:}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(f\textcolor{stringliteral}{"{}Twilio\ -\/>\ Media\ stream\ \{stream\_sid\}\ ended."{}})}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break}}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ message\_queue.task\_done()}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ listener\_task\ =\ asyncio.create\_task(websocket\_listener())}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ processor\_task\ =\ asyncio.create\_task(message\_processor())}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ await\ asyncio.gather(listener\_task,\ processor\_task)}
\DoxyCodeLine{00185\ \ \ \ \ \textcolor{keywordflow}{except}\ asyncio.CancelledError:}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ logger.info(\textcolor{stringliteral}{"{}Tasks\ cancelled"{}})}
\DoxyCodeLine{00187\ \ \ \ \ \textcolor{keywordflow}{finally}:}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ await\ transcription\_service.disconnect()}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ }

\end{DoxyCode}


References \mbox{\hyperlink{l00191}{get\+\_\+twilio\+\_\+client()}}.

Here is the call graph for this function\+:
% FIG 5


\doxysubsection{Variable Documentation}
\Hypertarget{namespaceapp_afe63fea7be31b0200b496d08bc6b517d}\index{app@{app}!app@{app}}
\index{app@{app}!app@{app}}
\doxysubsubsection{\texorpdfstring{app}{app}}
{\footnotesize\ttfamily \label{namespaceapp_afe63fea7be31b0200b496d08bc6b517d} 
app = Fast\+API()}

\Hypertarget{namespaceapp_aef7f4ba3e723d6fd588089b84d83b37c}\index{app@{app}!call\_contexts@{call\_contexts}}
\index{call\_contexts@{call\_contexts}!app@{app}}
\doxysubsubsection{\texorpdfstring{call\_contexts}{call\_contexts}}
{\footnotesize\ttfamily \label{namespaceapp_aef7f4ba3e723d6fd588089b84d83b37c} 
dict call\+\_\+contexts = \{\}}

\Hypertarget{namespaceapp_a832ddc04754e8a43d4f3c6165b1294a7}\index{app@{app}!host@{host}}
\index{host@{host}!app@{app}}
\doxysubsubsection{\texorpdfstring{host}{host}}
{\footnotesize\ttfamily \label{namespaceapp_a832ddc04754e8a43d4f3c6165b1294a7} 
host}

\Hypertarget{namespaceapp_a0b14e488ae28d98d262453f3e9cd6e4d}\index{app@{app}!logger@{logger}}
\index{logger@{logger}!app@{app}}
\doxysubsubsection{\texorpdfstring{logger}{logger}}
{\footnotesize\ttfamily \label{namespaceapp_a0b14e488ae28d98d262453f3e9cd6e4d} 
logger = get\+\_\+logger("{}App"{})}

\Hypertarget{namespaceapp_af8fb0f45ee0195c7422a49e6a8d72369}\index{app@{app}!port@{port}}
\index{port@{port}!app@{app}}
\doxysubsubsection{\texorpdfstring{port}{port}}
{\footnotesize\ttfamily \label{namespaceapp_af8fb0f45ee0195c7422a49e6a8d72369} 
port = int(os.\+getenv("{}PORT"{}, 3000))}

